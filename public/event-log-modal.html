<style>
    /* ==================== å…¨æ–°äº‹ä»¶ç´€éŒ„ Modal V4 (ç²¾ç·»åŒ–é›™æ¬„ä½ˆå±€) æ¨£å¼ ==================== */

    #event-log-modal .modal-content {
        max-width: 1400px;
    }
    
    #event-log-modal .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #event-log-modal .modal-header .action-buttons {
        display: flex;
        align-items: center;
        gap: var(--spacing-3);
    }
    #event-log-modal .modal-header .action-buttons .action-btn,
    #event-log-modal .modal-header .action-buttons .close-btn {
        padding: var(--spacing-2) var(--spacing-4);
        font-size: var(--font-size-sm);
        height: auto;
        margin-bottom: 0; 
    }
     #event-log-modal .modal-header .action-buttons .close-btn {
        width: auto;
     }

    .form-step-group {
        background-color: var(--primary-bg);
        padding: var(--spacing-6);
        border-radius: var(--rounded-xl);
        border: 1px solid var(--border-color);
        margin-bottom: var(--spacing-6);
    }
    
    .form-step-group .form-step-label {
        font-size: var(--font-size-lg);
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: var(--spacing-5);
        display: flex;
        align-items: center;
    }
    
    .form-step-label .step-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--accent-blue);
        color: white;
        font-size: 1rem;
        margin-right: var(--spacing-3);
    }

    .segmented-control {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-2);
    }

    .segmented-control label {
        flex-grow: 1;
        text-align: center;
        padding: var(--spacing-3) var(--spacing-4);
        border-radius: var(--rounded-lg);
        cursor: pointer;
        font-weight: 600;
        color: var(--text-secondary);
        background-color: var(--secondary-bg);
        border: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .segmented-control label:hover {
        background-color: var(--glass-bg);
    }

    .segmented-control input[type="radio"] {
        display: none;
    }

    .segmented-control input[type="radio"]:checked + label {
        background-color: var(--accent-blue);
        color: white;
        border-color: var(--accent-blue);
        box-shadow: var(--shadow-md);
    }
    
    .selected-item-display {
        background: var(--primary-bg);
        padding: var(--spacing-3) var(--spacing-4);
        border-radius: var(--rounded-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--border-color);
    }
    .selected-item-display span {
        font-weight: 600;
    }
    
    #event-form-container fieldset {
        border: none;
        padding: 0;
        margin: 0;
        min-width: 0;
    }
    #event-form-container legend {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: var(--spacing-4);
        padding-bottom: var(--spacing-3);
        border-bottom: 1px solid var(--border-color);
        width: 100%;
    }
    
    .form-columns-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--spacing-8);
    }

    .participants-checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: var(--spacing-3);
        background: var(--primary-bg);
        padding: var(--spacing-4);
        border-radius: var(--rounded-lg);
        border: 1px solid var(--border-color);
        max-height: 180px;
        overflow-y: auto;
    }
    .participants-checkbox-group label {
        display: flex;
        align-items: center;
        gap: var(--spacing-2);
        cursor: pointer;
        padding: var(--spacing-2);
        border-radius: var(--rounded-md);
        transition: background-color 0.2s ease;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
     .participants-checkbox-group label:hover {
        background-color: var(--glass-bg);
     }
    .participants-checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--accent-blue);
        flex-shrink: 0;
    }
    .other-participant-input {
        margin-top: var(--spacing-3);
    }
    
    @media (max-width: 900px) {
        .form-columns-container {
            grid-template-columns: 1fr;
        }
    }

    /* --- ã€æ–°å¢ã€‘Wizard å°ˆå±¬æ¨£å¼ --- */
    #new-event-wizard-modal .modal-content {
        max-width: 900px;
    }
    /* å¼•ç”¨ç¾æœ‰ Wizard æ¨£å¼ */
    .wizard-steps {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 0 20px;
    }
    .step-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 2;
        color: var(--text-muted);
        font-weight: 500;
        opacity: 0.6;
        transition: all 0.3s ease;
    }
    .step-item.active {
        color: var(--accent-blue);
        opacity: 1;
    }
    .step-circle {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background-color: var(--card-bg);
        border: 2px solid var(--text-muted);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        margin-bottom: 8px;
        transition: all 0.3s ease;
    }
    .step-item.active .step-circle {
        border-color: var(--accent-blue);
        background-color: var(--accent-blue);
        color: white;
        box-shadow: 0 0 10px rgba(96, 165, 250, 0.4);
    }
    .step-label {
        font-size: 0.9rem;
    }
    .step-line {
        flex-grow: 1;
        height: 2px;
        background-color: var(--border-color);
        margin: 0 15px;
        margin-bottom: 20px; /* å°é½Šåœ“åœˆ */
    }

    /* Entry Options for Event */
    .event-entry-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 10px;
    }
    .event-entry-card {
        background: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: var(--rounded-lg);
        padding: 30px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }
    .event-entry-card:hover {
        border-color: var(--accent-blue);
        background: var(--glass-bg);
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }
    .event-entry-card.selected {
        border-color: var(--accent-blue);
        background: color-mix(in srgb, var(--accent-blue) 10%, var(--card-bg));
    }

    /* Type Grid (Modified: 4 Columns, Vertical Card) */
    .type-entry-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr); /* æ”¹ç‚º 4 æ¬„ */
        gap: 15px;
        margin-bottom: 20px;
    }
    
    /* åœ¨å°è¢å¹•ä¸Šè‡ªå‹•åˆ‡æ›ç‚º 2 æ¬„ï¼Œé¿å…å¤ªæ“  */
    @media (max-width: 768px) {
        .type-entry-grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    .type-card {
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px 10px; /* å¢åŠ ä¸Šä¸‹ padding */
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column; /* æ”¹ç‚ºå‚ç›´æ’åˆ— */
        align-items: center;
        text-align: center;
        gap: 12px;
        height: 100%; /* ç¢ºä¿é«˜åº¦ä¸€è‡´ */
    }
    .type-card:hover {
        background: var(--glass-bg);
        border-color: var(--accent-blue);
        transform: translateY(-2px);
    }
    .type-card.selected {
        background: color-mix(in srgb, var(--accent-blue) 10%, var(--secondary-bg));
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 1px var(--accent-blue);
    }
    .type-icon {
        font-size: 1.5rem;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--primary-bg);
        border-radius: 50%;
        flex-shrink: 0;
        margin-bottom: 5px; /* å¢åŠ åœ–ç¤ºä¸‹æ–¹é–“è· */
    }
    .type-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    .type-title {
        font-weight: 700;
        color: var(--text-primary);
        font-size: 1rem;
    }
    .type-desc {
        font-size: 0.8rem;
        color: var(--text-muted);
        line-height: 1.4;
    }


    .tag-selection-area {
        background: var(--glass-bg);
        border: 1px solid var(--border-color);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .tag-group-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-muted);
        margin-bottom: 10px;
        display: block;
    }
    .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    .wiz-tag {
        padding: 6px 14px;
        border: 1px solid var(--border-color);
        border-radius: 20px;
        background-color: var(--secondary-bg);
        color: var(--text-secondary);
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        user-select: none;
        transition: all 0.2s ease;
    }
    .wiz-tag:hover {
        border-color: var(--accent-blue);
    }
    .wiz-tag.selected {
        background-color: var(--accent-blue);
        color: white;
        border-color: var(--accent-blue);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

</style>

<div id="event-log-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="event-log-modal-title">âœï¸ ç·¨è¼¯äº‹ä»¶ç´€éŒ„</h2>
            <div class="action-buttons">
                <button class="close-btn" onclick="closeModal('event-log-modal')">&times;</button>
            </div>
        </div>
        
        <form id="event-log-form">
            <input type="hidden" id="event-log-eventId" name="eventId">
            <input type="hidden" id="event-log-opportunityId" name="opportunityId">
            <input type="hidden" id="event-log-companyId" name="companyId">
            <input type="hidden" id="event-log-type" name="originalEventType">

            <div class="form-step-group" id="event-link-section" style="display: none;">
                 <label class="form-step-label"><span class="step-number">1</span> é—œè¯å°è±¡</label>
                 <div class="segmented-control">
                    <input type="radio" name="linkType" value="opportunity" id="link-opp" onchange="toggleEventLinkType()">
                    <label for="link-opp">æ©Ÿæœƒæ¡ˆä»¶</label>
                    <input type="radio" name="linkType" value="company" id="link-comp" onchange="toggleEventLinkType()">
                    <label for="link-comp">å…¬å¸ç¸½è¦½</label>
                </div>
                <div id="event-log-entity-selector" class="form-group"></div>
            </div>

            <div class="form-step-group">
                <label class="form-step-label"><span class="step-number">1</span> äº‹ä»¶é¡å‹</label>
                <div class="segmented-control">
                    <input type="radio" name="eventType" value="general" id="type-general" onchange="loadEventTypeForm(this.value)" checked>
                    <label for="type-general">ä¸€èˆ¬</label>
                    
                    <input type="radio" name="eventType" value="iot" id="type-iot" onchange="loadEventTypeForm(this.value)">
                    <label for="type-iot">IOT</label>
                    
                    <input type="radio" name="eventType" value="dt" id="type-dt" onchange="loadEventTypeForm(this.value)">
                    <label for="type-dt">DT</label>

                    <input type="radio" name="eventType" value="dx" id="type-dx" onchange="loadEventTypeForm(this.value)">
                    <label for="type-dx">DX</label>
                </div>
            </div>

            <div class="form-step-group">
                <label class="form-step-label"><span class="step-number">2</span> è©³ç´°å…§å®¹</label>
                <div class="form-group" id="admin-created-time-group" style="display: none; background: color-mix(in srgb, var(--accent-red) 10%, var(--primary-bg)); padding: var(--spacing-4); border-radius: var(--rounded-lg); border: 1px solid var(--accent-red); margin-bottom: var(--spacing-5);">
                    <label for="event-log-createdTime" class="form-label">âš ï¸ (ç®¡ç†å“¡) è¦†å¯«å»ºç«‹æ™‚é–“</label>
                    <input type="datetime-local" class="form-input" id="event-log-createdTime" name="createdTime">
                </div>
                <div id="event-form-container">
                    </div>
            </div>

            <div class="btn-group">
                <button type="button" class="action-btn danger" id="event-log-delete-btn" style="display: none; margin-right: auto;">ğŸ—‘ï¸ åˆªé™¤</button>
                <button type="submit" class="action-btn primary" id="event-log-submit-btn">ğŸ’¾ å„²å­˜è®Šæ›´</button>
            </div>
        </form>
    </div>
</div>

<div id="new-event-wizard-modal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h2 class="modal-title">ğŸ“ æ–°å¢äº‹ä»¶ç´€éŒ„</h2>
            <button class="close-btn" onclick="closeModal('new-event-wizard-modal')">&times;</button>
        </div>

        <div class="wizard-steps">
            <div class="step-item active" data-wiz-step="1">
                <div class="step-circle">1</div>
                <div class="step-label">é–å®šå°è±¡</div>
            </div>
            <div class="step-line"></div>
            <div class="step-item" data-wiz-step="2">
                <div class="step-circle">2</div>
                <div class="step-label">å®šç¾©äº‹ä»¶</div>
            </div>
            <div class="step-line"></div>
            <div class="step-item" data-wiz-step="3">
                <div class="step-circle">3</div>
                <div class="step-label">èˆ‡æœƒäººå“¡</div>
            </div>
        </div>

        <form id="event-wizard-form" onsubmit="return false;">
            <div class="wizard-step-content" data-wiz-content="1">
                <h3 class="step-instruction">è«‹å•é€™å€‹äº‹ä»¶çš„é—œè¯å°è±¡æ˜¯ï¼Ÿ</h3>
                
                <div class="event-entry-grid">
                    <div class="event-entry-card" onclick="EventWizard.selectTargetType('opportunity', this)">
                        <div class="entry-icon" style="width: 60px; height: 60px; font-size: 2.5rem; display: flex; align-items: center; justify-content: center;">ğŸ¯</div>
                        <div class="entry-title">æ©Ÿæœƒæ¡ˆä»¶</div>
                        <div class="entry-desc">ç‰¹å®šåˆä½œæˆ–è¨‚å–®ï¼Œ<br>æœ‰æ˜ç¢ºè­°é¡Œèˆ‡éŠ·å”®éšæ®µ</div>
                    </div>
                    <div class="event-entry-card" onclick="EventWizard.selectTargetType('company', this)">
                        <div class="entry-icon" style="width: 60px; height: 60px; font-size: 2.5rem; display: flex; align-items: center; justify-content: center;">ğŸ¢</div>
                        <div class="entry-title">å…¬å¸ç¸½è¦½</div>
                        <div class="entry-desc">ä¾‹è¡Œæ‹œè¨ªã€SI/ä»£ç†å•†å•†è«‡ï¼Œ<br>ç„¡ç‰¹å®šæ©ŸæœƒèƒŒæ™¯</div>
                    </div>
                </div>

                <div id="wiz-target-search-area" style="margin-top: 20px; display: none;">
                     <div class="form-group">
                        <label class="form-label" id="wiz-search-label">æœå°‹åç¨±</label>
                        <div class="search-input-wrapper">
                            <input type="text" class="form-input" id="wiz-target-search" placeholder="é»æ“Šè¼¸å…¥æœå°‹ï¼Œæˆ–ç›´æ¥å¾ä¸‹æ–¹é¸æ“‡..." onkeyup="EventWizard.searchTargets(this.value)" onclick="EventWizard.searchTargets(this.value)">
                        </div>
                        <div id="wiz-target-results" class="search-result-list"></div>
                    </div>
                </div>
            </div>

            <div class="wizard-step-content" data-wiz-content="2" style="display: none;">
                
                <div class="type-entry-grid">
                    <div class="type-card selected" onclick="EventWizard.selectEventType('general', this)">
                        <div class="type-icon">ğŸ“</div>
                        <div class="type-info">
                            <div class="type-title">ä¸€èˆ¬ç´€éŒ„</div>
                            <div class="type-desc">ä¾‹è¡Œæ‹œè¨ªã€å°šæœªç¢ºå®šä¸»é¡Œ</div>
                        </div>
                    </div>
                    <div class="type-card" onclick="EventWizard.selectEventType('iot', this)">
                        <div class="type-icon">ğŸ­</div>
                        <div class="type-info">
                            <div class="type-title">æ™ºæ…§è£½é€  (IoT)</div>
                            <div class="type-desc">è¨­å‚™è¯ç¶²ã€ç”Ÿç”¢ç·šç›£æ§</div>
                        </div>
                    </div>
                    <div class="type-card" onclick="EventWizard.selectEventType('dt', this)">
                        <div class="type-icon">ğŸ“Š</div>
                        <div class="type-info">
                            <div class="type-title">åŠ å·¥æ‡‰ç”¨ (DT)</div>
                            <div class="type-desc">åƒæ•¸å„ªåŒ–ã€ç•°å¸¸åˆ†æ</div>
                        </div>
                    </div>
                    <div class="type-card" onclick="EventWizard.selectEventType('dx', this)">
                        <div class="type-icon">ğŸš€</div>
                        <div class="type-info">
                            <div class="type-title">æ•¸ä½è½‰å‹ (DX)</div>
                            <div class="type-desc">å‰µæ–°å•†æ¨¡ã€è·¨ç³»çµ±æ•´åˆ</div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                     <div class="form-group">
                        <label class="form-label">äº‹ä»¶åç¨± *</label>
                        <input type="text" class="form-input" id="wiz-event-name" placeholder="ä¾‹å¦‚ï¼šéœ€æ±‚è¨ªè«‡ã€ç”¢å“ç°¡å ±...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ç™¼ç”Ÿæ™‚é–“ *</label>
                        <input type="datetime-local" class="form-input" id="wiz-event-time">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æœƒè­°åœ°é»</label>
                    <input type="text" class="form-input" id="wiz-event-location" placeholder="ä¾‹å¦‚ï¼šå®¢æˆ¶æœƒè­°å®¤ã€Teamsç·šä¸Š...">
                </div>
            </div>

            <div class="wizard-step-content" data-wiz-content="3" style="display: none;">
                <h3 class="step-instruction">è«‹å•æœ‰å“ªäº›äººåƒèˆ‡ï¼Ÿ</h3>
                
                <div class="tag-selection-area">
                    <span class="tag-group-label">æˆ‘æ–¹äººå“¡ (é»æ“Šé¸å–)</span>
                    <div class="tags-container" id="wiz-our-participants">
                        <span style="color: var(--text-muted);">è¼‰å…¥ä¸­...</span>
                    </div>
                </div>

                <div class="tag-selection-area">
                    <span class="tag-group-label">å®¢æˆ¶äººå“¡ (é»æ“Šé¸å–)</span>
                    <div class="tags-container" id="wiz-client-participants">
                        <span style="color: var(--text-muted);">è«‹å…ˆé–å®šå°è±¡ä»¥è¼‰å…¥è¯çµ¡äºº</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <input type="text" class="form-input" id="wiz-manual-participants" placeholder="æ‰‹å‹•è¼¸å…¥å…¶ä»–èˆ‡æœƒè€… (ç”¨é€—è™Ÿåˆ†éš”)">
                </div>
            </div>

            <div class="wizard-footer">
                <button type="button" class="action-btn secondary" id="wiz-prev-btn" onclick="EventWizard.prevStep()" style="display: none;">&lt; ä¸Šä¸€æ­¥</button>
                <span style="flex-grow: 1;"></span>
                <button type="button" class="action-btn primary" id="wiz-next-btn" onclick="EventWizard.nextStep()">ä¸‹ä¸€æ­¥ &gt;</button>
                <button type="button" class="action-btn primary" id="wiz-create-btn" onclick="EventWizard.create()" style="display: none;">âœ… å»ºç«‹ä¸¦ç·¨è¼¯è©³æƒ…</button>
            </div>
        </form>
    </div>
</div>